<script type="text/javascript">
  RED.nodes.registerType('oauth2-auth',{
      category: 'network',
      paletteLabel: 'oauth2 auth',
      color: '#d7d7a0',
      defaults: {
          grant_type: {value: "authorization_code"},
          client_id: {value: "", required: true},
          client_secret: {value: "", required: true},
          scope: {value: ""},
          state: {value: ""},
          authentication_url: {value: "", required: true},
          redirect_url: {value: ""},
          access_token_url: {value: "", required: true},
          name: {value: ""}
      },
      inputs:1,
      outputs:1,
      icon: "white-globe.svg",
      label: function() { return this.name || this._("oauth2auth.label.label"); },
      labelStyle: function () { return this.name ? "node_label_italic" : ""; },

      oneditprepare: function()
      {
        var id = this.id;

        function updateButtonAuthorize() {
          var client_id = $("#node-input-client_id").val();
          var client_secret = $("#node-input-client_secret").val();
          var authentication_url = $("#node-input-authentication_url").val();
          var redirect_url = $("#node-input-redirect_url").val();
          var access_token_url = $("#node-input-access_token_url").val();

          $("#node-button-authorize").toggleClass("ui-state-disabled", (client_id.length === 0 || client_secret.length === 0 || authentication_url === 0 || redirect_url === 0 || access_token_url === 0));
        }

        updateButtonAuthorize();

        $("#node-input-redirect_url").val(document.location.origin + '/oauth2-auth/callback');
        $("#node-input-client_id").on('change keydown paste input', updateButtonAuthorize);
        $("#node-input-client_secret").on('change keydown paste input', updateButtonAuthorize);
        $("#node-input-authentication_url").on('change keydown paste input', updateButtonAuthorize);
        $("#node-input-redirect_url").on('change keydown paste input', updateButtonAuthorize);
        $("#node-input-access_token_url").on('change keydown paste input', updateButtonAuthorize);

        $("#node-button-authorize").mousedown(function() {
          var client_id = $("#node-input-client_id").val();
          var client_secret = $("#node-input-client_secret").val();
          var authentication_url = $("#node-input-authentication_url").val();
          var redirect_url = $("#node-input-redirect_url").val();
          var access_token_url = $("#node-input-access_token_url").val();
          var scope = $("#node-input-scope").val();
          var grant_type = $("#node-input-grant_type").val();

          if (grant_type == "authorization_code") {
            var url = "oauth2-auth/auth?id="+id
                    +"&client_id="+client_id
                    +"&client_secret="+client_secret
                    +"&authentication_url="+encodeURIComponent(authentication_url)
                    +"&redirect_url="+encodeURIComponent(redirect_url)
                    +"&access_token_url="+encodeURIComponent(access_token_url)
                    +(scope.length !== 0 ? "&scope="+scope : "");
            $(this).attr("href", url);
          }
        });

        $("#node-button-authorize").click(function(e) {
          var client_id = $("#node-input-client_id").val();
          var client_secret = $("#node-input-client_secret").val();
          var authentication_url = $("#node-input-authentication_url").val();
          var redirect_url = $("#node-input-redirect_url").val();
          var access_token_url = $("#node-input-access_token_url").val();

          console.log(client_id.length);

          if (client_id.length === 0 || client_secret.length === 0 || authentication_url === 0 || redirect_url === 0 || access_token_url === 0) {
            e.preventDefault();
          }
        });
      }
  });
</script>

<script type="text/html" data-template-name="oauth2-auth">
  <!-- Grant Type -->
  <div class="form-row">
    <label for="node-input-grant_type"><i class="fa fa-wrench"></i><span data-i18n="oauth2auth.label.grant_type"></span></label>
    <select type="text" id="node-input-grant_type" placeholder="Grant Type">
      <option value="authorization_code" data-i18n="oauth2auth.label.opt_authorization_code"></option>
    </select>
  </div>

  <!-- Client Id -->
  <div class="form-row">
    <label for="node-input-client_id"><i class="fa fa-user fa-fw"></i><span data-i18n="oauth2auth.label.client_id"></span></label>
    <input type="text" id="node-input-client_id" data-i18n="[placeholder]oauth2auth.label.client_id">
  </div>

  <!-- Client Secret -->
  <div class="form-row">
    <label for="node-input-client_secret"><i class="fa fa-lock fa-fw"></i><span data-i18n="oauth2auth.label.client_secret"></span></label>
    <input type="password" id="node-input-client_secret">
  </div>

  <!-- Scope -->
  <div class="form-row">
    <label for="node-input-scope"><i class="fa fa-code fa-fw"></i><span data-i18n="oauth2auth.label.scope"></span></label>
    <input type="text" id="node-input-scope" data-i18n="[placeholder]oauth2auth.label.scope">
  </div>

  <!-- Authentication Url -->
  <div class="form-row">
    <label for="node-input-authentication_url"><i class="fa fa-link fa-fw"></i><span data-i18n="oauth2auth.label.authentication_url"></span></label>
    <input type="text" id="node-input-authentication_url" data-i18n="[placeholder]oauth2auth.label.authentication_url">
  </div>
      
  <!-- Redirect Url -->
  <div class="form-row">
    <label for="node-input-redirect_url"><i class="fa fa-link fa-fw"></i><span data-i18n="oauth2auth.label.redirect_url"></span></label>
    <input readonly type="text" id="node-input-redirect_url" data-i18n="[placeholder]oauth2auth.label.redirect_url">
  </div>

  <!-- Access Token Url -->
  <div class="form-row">
    <label for="node-input-access_token_url"><i class="fa fa-link fa-fw"></i><span data-i18n="oauth2auth.label.access_token_url"></span></label>
    <input type="text" id="node-input-access_token_url" data-i18n="[placeholder]oauth2auth.label.access_token_url">
  </div>

  <!-- Authorize Button -->
  <div class="form-row">
    <label>&nbsp;</label>
    <a class="ui-button ui-corner-all" id="node-button-authorize" href="#" target="_blank"><span data-i18n="oauth2auth.label.authorize"></span></a>
 </div>

  <!-- Name -->
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i><span data-i18n="oauth2auth.label.name"></span></label>
    <input type="text" id="node-input-name" data-i18n="[placeholder]oauth2auth.label.name">
  </div>
</script>

<script type="text/html" data-help-name="oauth2-auth">
  <span data-i18n="oauth2auth.message.help_text">
</script>