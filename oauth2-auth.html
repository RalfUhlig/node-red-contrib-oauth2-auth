<script type="text/javascript">
  RED.nodes.registerType('oauth2-auth',{
      category: 'network',
      paletteLabel: 'OAuth2 Authorization',
      color: '#d7d7a0',
      defaults: {
          grant_type: {value: "authorization_code"},
          client_id: {value: "", required: true},
          client_secret: {value: "", required: true},
          scope: {value: ""},
          state: {value: ""},
          authentication_url: {value: "", required: true},
          redirect_url: {value: ""},
          access_token_url: {value: "", required: true},
          name: {value: ""}
      },
      inputs:1,
      outputs:1,
      icon: "white-globe.svg",
      label: function() { return this.name||"oauth2-auth"; },
      labelStyle: function () { return this.name ? "node_label_italic" : ""; },

      oneditprepare: function()
      {
        var id = this.id;

        function updateButtonAuthorize() {
          var client_id = $("#node-input-client_id").val();
          var client_secret = $("#node-input-client_secret").val();
          var authentication_url = $("#node-input-authentication_url").val();
          var redirect_url = $("#node-input-redirect_url").val();
          var access_token_url = $("#node-input-access_token_url").val();

          $("#node-button-authorize").toggleClass("disabled", (client_id.length === 0 || client_secret.length === 0 || authentication_url === 0 || redirect_url === 0 || access_token_url === 0));
        }

        updateButtonAuthorize();

        $("#node-input-redirect_url").val(document.location.origin + '/oauth/callback');
        $("#node-input-client_id").on('change keydown paste input', updateButtonAuthorize);
        $("#node-input-client_secret").on('change keydown paste input', updateButtonAuthorize);
        $("#node-input-authentication_url").on('change keydown paste input', updateButtonAuthorize);
        $("#node-input-redirect_url").on('change keydown paste input', updateButtonAuthorize);
        $("#node-input-access_token_url").on('change keydown paste input', updateButtonAuthorize);

        $("#node-button-authorize").mousedown(function() {
          var client_id = $("#node-input-client_id").val();
          var client_secret = $("#node-input-client_secret").val();
          var redirect_url = $("#node-input-redirect_url").val();
          var grant_type = $("#node-input-grant_type").val();

          if (grant_type == "authorization_code") {
            var url = 'oauth2-auth/auth?id='+id+'&client_id='+client_id+"&client_secret="+client_secret+"&callback="+encodeURIComponent(redirect_url);
            $(this).attr("href", url);
          }
        });

        $("#node-button-authorize").click(function(e) {
          var client_id = $("#node-input-client_id").val();
          var client_secret = $("#node-input-client_secret").val();
          var authentication_url = $("#node-input-authentication_url").val();
          var redirect_url = $("#node-input-redirect_url").val();
          var access_token_url = $("#node-input-access_token_url").val();

          console.log(client_id.length);

          if (client_id.length === 0 || client_secret.length === 0 || authentication_url === 0 || redirect_url === 0 || access_token_url === 0) {
            e.preventDefault();
          }
        });
      }
  });
</script>

<script type="text/html" data-template-name="oauth2-auth">
  <!-- Grant Type -->
  <div class="form-row">
    <label for="node-input-grant_type"><i class="fa fa-wrench"></i>Grant Type</label>
    <select type="text" id="node-input-grant_type" placeholder="Grant Type">
      <option value="authorization_code">Authorization Code</option>
    </select>
  </div>

  <!-- Client Id -->
  <div class="form-row">
    <label for="node-input-client_id"><i class="fa fa-user fa-fw"></i>Client Id</label>
    <input type="text" id="node-input-client_id" placeholder="Client Id">
  </div>

  <!-- Client Secret -->
  <div class="form-row">
    <label for="node-input-client_secret"><i class="fa fa-lock fa-fw"></i>Client Secret</label>
    <input type="password" id="node-input-client_secret" placeholder="Client Secret">
  </div>

  <!-- Scope -->
  <div class="form-row">
    <label for="node-input-scope"><i class="fa fa-code fa-fw"></i>Scope</label>
    <input type="text" id="node-input-scope" placeholder="Scope">
  </div>

  <!-- Authentication Url -->
  <div class="form-row">
    <label for="node-input-authentication_url"><i class="fa fa-link fa-fw"></i>Authentication Url</label>
    <input type="text" id="node-input-authentication_url" placeholder="Authentication Url">
  </div>
      
  <!-- Redirect Url -->
  <div class="form-row">
    <label for="node-input-redirect_url"><i class="fa fa-link fa-fw"></i>Redirect Url</label>
    <input readonly type="text" id="node-input-redirect_url" placeholder="Redirect Url">
  </div>

  <!-- Access Token Url -->
  <div class="form-row">
    <label for="node-input-access_token_url"><i class="fa fa-link fa-fw"></i>Access Token Url</label>
    <input type="text" id="node-input-access_token_url" placeholder="Access Token Url">
  </div>

  <!-- Authorize Button -->
  <div class="form-row">
    <label>&nbsp;</label>
    <a class="ui-button ui-corner-all" id="node-button-authorize" href="#" target="_blank">Authorize</a>
 </div>

  <!-- Name -->
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i>Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
</script>

<script type="text/html" data-help-name="oauth2-auth">
  <p>OAuth2 client for getting oauth2 credentials by the authorization flow to use in other nodes. Credentials are automatically refreshed on expiration.</p>
</script>